<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=utf8" />
<title>小Ann</title>
 <script src="jquery.min.js"></script>
 <script src="FileSaver.js"></script>
</head>
<style>
body {
	margin: 0.5em;
	padding: 0.5em;
}

#head{
    padding-bottom: 1em;
    position: fixed;
    top:0em;
    margin: 0em; 
    padding: 1em; 
    left: 0;
    right: 0;
    background: white;
    font-size: 1.3em;
}
#import{
    float: left;
    width:50%;
    background: white;
}
#state{
    right: 2em;
    float: right;
}
#main{
    display: inline;
    padding: 1em;
    position: relative;  
    width: 100%;
}

#CurrentContent{
    width: 80%;
	font-size: 1.5em;
    margin-top: 8em;  
    margin-bottom: 8em;  
    float: left;
    position: relative;
    z-index: -999;

}
#info_list{
    width: 15%;
    float: right;
    position: fixed;
    right: 2em;
    margin-top: 13em;
}
ul li{

    list-style: none;
    width: 160px;

}
ul li p{
    border-style: solid;
    border-color: gray;
    text-align: center;
    width: 100%;
    font-size: 1em;
    position: relative;
    float: left;
    margin: 0.5em;
}
ul li button{
    border-style: solid;
    border-color: gray;
    width: 40%;
    margin: 0.5em;
    font-size: 1em;

}
button{
    border-style: solid;
    border-color: gray;
    margin: 0.1em;
    font-size: 0.8em;

}
#bottom{
    position: fixed;
    bottom: 0;
    margin: 0em;  
    padding: 1em;
    left: 0;
    right: 0;
    overflow: hidden;
    background: white;
    font-size: 1.5em;
}
.text-popup {
    animation: textPopup 0.7s;
    color: red;
    user-select: none;
    white-space: nowrap;
    position: absolute;
    z-index: 99;
    font-size: 20px;
}
@keyframes textPopup {
    0%, 100% {
        opacity: 0;
    }
    5% {
        opacity: 1;
    }
</style>
<script>
var fnTextPopup = function (arr, options) {
    // arr参数是必须的
    if (!arr || !arr.length) {
        return;    
    }
    // 主逻辑
    var index = 0;
    document.documentElement.addEventListener('click', function (event) {
        var x = event.pageX, y = event.pageY;
        var item = event.target;
        if(item.tagName!="SPAN")return;
		var obj=document.elementFromPoint(event.clientX,event.clientY);
        var eleText = document.createElement('span');
        eleText.className = 'text-popup';
        this.appendChild(eleText);
        if (arr[index]) {
            eleText.innerHTML = arr[index];
        } else {
            index = 0;
            eleText.innerHTML = arr[0];
        }
        // 动画结束后删除自己
        eleText.addEventListener('animationend', function () {
            eleText.parentNode.removeChild(eleText);
        });
        // 位置
        eleText.style.left = (x - eleText.clientWidth / 2) + 'px';
        eleText.style.top = (y - eleText.clientHeight) + 'px';
        // index递增
        index++;
    });    
};

fnTextPopup(['|']);
</script>
<body>
    <div id="head">
            <h1>小Ann标注工具</h1>
            <div id="import">
            	<a>导入标注工程文件</a>
                <input type="file" id="files" style="font-size: 0.8em" onchange="fileImport();">
            </div>
            <div id="state">
                <a id="progress">当前进度：无</a>
            </div>
    </div>
    <div id="main">
        <div id="CurrentContent">

        </div>  
        <div id="info_list">
            <ul>
                <li>
                    <p id="annoted_spo" style="background:#A9A9A9">已标注：0 对三元组</p>
                </li>
                <li>
                    <p id="annoted_entity" style="background:#A9A9A9">已标注：0 个新实体</p>
                </li>                
                <li>
                    <p id="annoted_relation" style="background:#A9A9A9">已标注：0 个新关系</p>
                </li>                
                <li>
                    <p id="cancle_point" style="background:#A9A9A9">已取消：0 个标注点</p>
                </li>
                <li>
                    <button style="background:#DAA520;float: left" onclick="add_entity()">实体</button> 
                    <button style="background:#9ACD32;float: left" onclick="add_relation()">关系</button> 
                </li>
                <li>
                    <button style="background:#D2691E;float: left" onclick="cancle()">取消</button>
                </li>
                <li>
                    <button style="background:#4682B4" onclick="save()">保存</button>
                </li>
                <li>
                    <p id="indicator" style="background:gray;width: 40%;right: -40px">已选中</ps>
                </li>
            </ul>
        </div>  
    </div>
<div id="bottom">
    <button style="padding: 0.5em" onclick="last()">上一条</button>
    <a style="padding: 0.5em">当前选择：</a>
    <a id="selected" style="padding: 0.5em">等你点击或者选择</a>
    <button style="padding: 0.5em;float:right;" onclick="next()">下一条</button>
</div>
<script type="text/javascript">
    var txts;
	var imported_flag=0;
    var current_sample_index=-1;
    var current_char_index=-1;
    var total_char_index=-1;
    var length_list=[];
    var total=-1;
    var samples_current=[];
    var labels_current=[];
    var spo_lists=[];
    var spo=[];
    var obj_mousedown;
    var obj_mouseup;
    var filename="";
    var contents="";
    var count_new_entity=-1;
    var count_new_relation=-1;
    var count_cancled_point=-1;

function next(samples){
    current_sample_index+=1;
    if(current_sample_index>total){
        current_sample_index=total;
        return;
    }
    var progress_obj=document.getElementById("progress");
    progress_obj.innerHTML="当前进度："+current_sample_index+"/"+total;
    text2obj_color(samples_current[current_sample_index],labels_current[current_sample_index]);
}
function last(samples){
    current_sample_index-=1;
    if(current_sample_index<0){
        current_sample_index=0;
        return;
    }
    var progress_obj=document.getElementById("progress");
    progress_obj.innerHTML="当前进度："+current_sample_index+"/"+total;
    text2obj_color(samples_current[current_sample_index],labels_current[current_sample_index]);
}
function text2obj_color(text,label){
    var testobj=document.getElementById("CurrentContent");
    testobj.innerHTML="";
    for(var c in text){
        var char = document.createElement('span');
        char.innerHTML = text[c];
        if(label[c].length>2){
            if(label[c][0]=="B"){
                char.style.marginLeft="0.5em";
            }
            if(label[c][2]=="实") char.style.backgroundColor="#DAA520";
            else if(label[c][2]=="关") char.style.backgroundColor="#9ACD32";
        }
        if(text[c]=="\n"){
            char.style.backgroundColor="#800080";
            var br = document.createElement('br');
            testobj.appendChild(char);
            if(c!=0) testobj.appendChild(br);//这一批样本首字符为换行符，统计但不显示出来。
        }else  testobj.appendChild(char);
    }
}
function text2obj(text){
	var testobj=document.getElementById("CurrentContent");
	testobj.innerHTML="";
	for(var c in text){
        if(c==0&&text[c]=='\n')continue;
		var char = document.createElement('span');
		var a = document.createElement('a');
		char.innerHTML = text[c];
		testobj.appendChild(char);
	}
}
function save(){
    spo=[];
    if(imported_flag==0)return;
    var results=""
    var labels_result=[];
    var tokens_result=[];
    var spo_result=[];
    for(var i=0;i<contents.length;i++)spo_result.push("X");
    for (var i = 0; i <labels_current.length; i++) {
        for (var j = 0; j<labels_current[i].length; j++) {
            labels_result.push(labels_current[i][j]); 
            tokens_result.push(samples_current[i][j]=="\n"? "_换行符_":samples_current[i][j]);
        }
        
    }
    for(var i in spo_lists){
        console.log(spo_lists[i]);
        var spo_tmp=spo_lists[i].split(">");
        spo_result[parseInt(spo_tmp[0])]+=";"+spo_tmp.join(">");
    }
    for(var i in contents){
        if(spo_result[i][1]==";"){
            spo_result[i]=spo_result[i].replace("X;","");
        }
        results+=tokens_result[i]+"\t"+labels_result[i]+"\t"+spo_result[i]+"\n";
    }
    
    var blob = new Blob([results], {type: "text/plain;charset=utf-8"});
    saveAs(blob, filename+".lann");
}
function refresh(){
    spo=[];
    var indicator_obj=document.getElementById("indicator");
    indicator_obj.style.backgroundColor="gray";
    text2obj_color(samples_current[current_sample_index],labels_current[current_sample_index]);
    var annoted_spo_obj=document.getElementById("annoted_spo");
    annoted_spo_obj.innerHTML="已标注："+spo_lists.length+" 对三元组";
    var annoted_ent_obj=document.getElementById("annoted_entity");
    annoted_ent_obj.innerHTML="已标注："+count_new_entity+" 个新实体";
    var annoted_rel_obj=document.getElementById("annoted_relation");
    annoted_rel_obj.innerHTML="已标注："+count_new_relation+" 个新关系";
    var annoted_cap_obj=document.getElementById("cancle_point");
    annoted_cap_obj.innerHTML="已取消："+count_cancled_point+" 个标注点";
}
function add_entity(){
    var txtselected=window.getSelection().toString();
    if(txtselected!=""){
        labels_current[current_sample_index][current_char_index]='B_实体';
        for (var j = current_char_index+1; j<txtselected.length+current_char_index; j++) {
            labels_current[current_sample_index][j]='I_实体';
        }
        count_new_entity+=1;
        refresh();
    }
}
function add_relation(){
    var txtselected=window.getSelection().toString();
    if(txtselected!=""){
        labels_current[current_sample_index][current_char_index]='B_关系';
        for (var j = current_char_index+1; j<txtselected.length+current_char_index; j++) {
            labels_current[current_sample_index][j]='I_关系';
        }
        count_new_relation+=1;
        refresh();
    }
}
function cancle(){
    var txtselected=window.getSelection().toString();
    if(txtselected!=""){
        for (var j = current_char_index; j<txtselected.length+current_char_index; j++) {
            labels_current[current_sample_index][j]='O';
        }
            var cancle_poin_obj=document.getElementById("cancle_point");
            cancle_poin_obj.style.innerHTML="gray";
        count_cancled_point+=1;
    }

    refresh();
}
document.documentElement.addEventListener('mousedown', function (event) {
    obj_mousedown = event.target;
})
document.documentElement.addEventListener('mouseup', function (event) {
    obj_mouseup = event.target;
})
document.documentElement.addEventListener('click', function (event) {
	var item = event.target;
    if(imported_flag==0)return;
        var testobj=document.getElementById("CurrentContent");
        var lists = Array.from(testobj.querySelectorAll('span'));
        current_char_index=lists.indexOf(item);
	if(item.tagName=="SPAN"){//处理鼠标单击的情况
        var selected_obj=document.getElementById("selected");
        total_char_index_cal()
        selected_obj.innerHTML=item.innerHTML+" : "+total_char_index+" : "+labels_current[current_sample_index][current_char_index];
        if(spo.indexOf(total_char_index)!=-1){//重复点击的情况
            spo=[];
            var indicator_obj=document.getElementById("indicator");
            indicator_obj.style.backgroundColor="gray";
            return;
        }
        spo.push(total_char_index);
        var indicator_obj=document.getElementById("indicator");
        indicator_obj.style.backgroundColor="pink";
        if(spo.length==3){
            if(spo_lists.indexOf(spo.join(">"))==-1){//新的三元组
                spo_lists.push(spo.join(">"));
                spo=[];
            }
            var indicator_obj=document.getElementById("indicator");
            indicator_obj.style.backgroundColor="gray";
            refresh();
        }
	}else if(window.getSelection().toString()!="" && $(item).attr("id")=="CurrentContent"){////处理文字选中的情况
		var txt=window.getSelection().toString();
        current_char_index=Math.min(lists.indexOf(obj_mousedown),lists.indexOf(obj_mouseup));
        if(current_char_index==-1){
            window.getSelection().removeAllRanges();

            return;
        }
        total_char_index_cal();
        var selected_obj=document.getElementById("selected");
        selected_obj.innerHTML=txt+" : "+total_char_index;
	}
})
function total_char_index_cal(){
    total_char_index=0
    for(var i=0;i<current_sample_index;i++){
        total_char_index+=length_list[i]
    }
    total_char_index+=current_char_index;
}
function columnlize(contents){
    console.log("columnlize!");
    var contents_columnlized=[];
    for(var i in contents) contents_columnlized.push(contents[i]=="\n"? "_换行符_":contents[i]);
    return contents_columnlized.join("\n");
}
$("#fileImport").click(function () {
            $("#files").click();
        })
        function fileImport() {
            //获取读取我文件的File对象
            var selectedFile = document.getElementById('files').files[0];
            imported_flag=0;
            spo_lists=[];
            if(selectedFile.name==undefined)return;
            var name = selectedFile.name;//读取选中文件的文件名
            var size = selectedFile.size;//读取选中文件的大小
            filename=name[name.length-1]=="t"? name:name.slice(0,name.length-5);
            // console.log("文件名:"+filename+"大小:"+size);
            var reader = new FileReader();//这是核心,读取操作就是由它完成.
            reader.readAsText(selectedFile);//读取文件的内容,也可以读取文件的URL
            reader.onload = function () {
                //当读取完成后回调这个函数,然后此时文件的内容存储到了result中,直接操作即可
                txts=this.result; 
                var samples=[];
                var labels=[];
                var tmp="";
                var label_tmp=[];
                var spo_tmp=[];
                var spo_dic_tmp=[];
                imported_flag=1;
                contents=txts.split("\n");
                if(contents[0].indexOf("\t")==-1)contents=columnlize(txts).split("\n");
                for(i in contents){
                	c_l=contents[i].split("\t");
                    if(c_l.length>=3){//包含三元组空间，读取进来
                        spo_read=c_l[2];
                        if(spo_read[0]!="X"){                      
                            var spos=spo_read.split(";");
                            for(var i in spos)spo_lists.push(spos[i]);
                            } 
                    }
                    c=c_l[0];
                    if(c_l.length==1)l="O";//原始文本，无标注
                    else l=c_l[1];
                    
                    
                	if((c=="。" ||c=='_换行符_')&&(tmp.length>250)){
                        c= c=='_换行符_' ? "\n" : c;
                		tmp+=c;
                        label_tmp.push(l);
                		samples.push(tmp);
                        length_list.push(tmp.length);
                        labels.push(label_tmp);
                        label_tmp=[];
                		tmp="";
                	}else{
                        c= c=='_换行符_' ? "\n" : c;
                		tmp+=c;
                        label_tmp.push(l);
                	}
                }

                if(samples.indexOf(tmp)==-1&&tmp!=""&&tmp!="\n"){//追加剩下的，同时排除空和只有一个换行符的情况。
                    samples.push(tmp);
                    labels.push(label_tmp);
                }
                current_sample_index=0;    
                total=samples.length-1;
                count_new_entity=0;
                count_new_relation=0;
                count_cancled_point=0;
                var progress_obj=document.getElementById("progress");
                progress_obj.innerHTML="当前进度："+current_sample_index+"/"+total;
                samples_current=samples;
                labels_current=labels;
                refresh();
            }

        }
</script>
</body>